<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Buffering submission </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Buffering submission ">
    <meta name="generator" content="docfx 2.59.4.0">
    
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="buffering-submission">Buffering submission</h1>

<h2 id="introduction">Introduction</h2>
<p>A feature in Armonik.Extensions.Csharp allows buffered submission of tasks even if the submission calls are made iteratively. It is possible for the client to buffer task submissions when sending them.</p>
<p>In the situation where a client cannot control its iterative task submission calls, two function calls named <code>public async Task&lt;string&gt; SubmitAsync(...)</code> have been made available in ArmoniK.DevelopmentKit.Client.Unified.</p>
<p>The asynchronous methods SubmitAsync allows first to iteratively submit tasks without waiting for the taskId results.
The buffer is submitted when it is full, or after a specified time, whichever comes first. When it is sent after the specified time, the buffer might not be full.
A new buffer will then be made available to create a new batch of sends</p>
<h2 id="buffer-configuration">Buffer configuration</h2>
<p>The buffering can be set from the object <code>Properties</code> provided when the Service is created
Here below an example of configuration :</p>
<pre><code class="lang-csharp">var props = new Properties(TaskOptions,
                             configuration.GetSection(&quot;Grpc&quot;)[&quot;EndPoint&quot;])
              {
                MaxConcurrentBuffer = 10,
                MaxTasksPerBuffer   = 50,
                MaxParallelChannel  = 5,
                TimeTriggerBuffer   = TimeSpan.FromSeconds(10),
              };
</code></pre>
<p>where :
<code>MaxConcurrentBuffer</code> is the number of buffers that can be filled in asynchronous submitAsync calls</p>
<p><code>MaxTasksPerBuffer</code> is the capacity of one buffer to contain tasks before a sending trigger</p>
<p><code>MaxParallelChannel</code> is number of parallel grpc channel active able to submit in parallel</p>
<p><code>TimeTriggerBuffer</code> is a TimeSpan to trigger a buffer to be sended over a grpc channel</p>
<p>In this example there are 10 buffers of 50 tasks each that will be sent over 5 Grpc channels in parallel. In other words, 2 buffers of 50 tasks will be prepared per Grpc channel</p>
<h2 id="submission-method">Submission method</h2>
<p>The functions are the following:</p>
<p>The method below will asynchronously send the task without arguments serialization</p>
<pre><code class="lang-csharp">public async Task&lt;string&gt; SubmitAsync(string                    methodName,
                                      byte[]                    argument,
                                      IServiceInvocationHandler handler,
                                      CancellationToken         token = default)
</code></pre>
<p>The method below will asynchronously send the task and serialize arguments objects</p>
<pre><code class="lang-csharp">public async Task&lt;string&gt; SubmitAsync(string                    methodName,
                                        object[]                  argument,
                                        IServiceInvocationHandler handler,
                                        CancellationToken         token = default)
</code></pre>
<h2 id="example">Example</h2>
<p>Find below an example to configure and send tasks iteratively with buffering</p>
<h3 id="creation-and-configuration-unified-service">Creation and configuration Unified service</h3>
<p>This is the instanciation and configuration of Unified service</p>
<pre><code class="lang-csharp">  public class StressTests
  {
    public StressTests(IConfiguration configuration,
                       ILoggerFactory factory,
                       string         partition)
    {
      TaskOptions = new TaskOptions
                    {
                      MaxDuration = new Duration
                                    {
                                      Seconds = 3600 * 24,
                                    },
                      MaxRetries           = 3,
                      Priority             = 1,
                      EngineType           = EngineType.Unified.ToString(),
                      ApplicationVersion   = &quot;1.0.0-700&quot;,
                      ApplicationService   = &quot;ServiceApps&quot;,
                      ApplicationName      = &quot;Armonik.Samples.StressTests.Worker&quot;,
                      ApplicationNamespace = &quot;Armonik.Samples.StressTests.Worker&quot;,
                      PartitionId          = partition,
                    };

      var props = new Properties(TaskOptions,
                             configuration.GetSection(&quot;Grpc&quot;)[&quot;EndPoint&quot;])
              {
                MaxConcurrentBuffer = 5,
                MaxTasksPerBuffer   = 50,
                MaxParallelChannel  = 5,
                TimeTriggerBuffer   = TimeSpan.FromSeconds(10),
              };

      Logger = factory.CreateLogger&lt;StressTests&gt;();

      Service = ServiceFactory.CreateService(Props,
                                             factory);

      ResultHandle = new ResultForStressTestsHandler(Logger);
    }
</code></pre>
<h3 id="example-of-execution-tasks">Example of execution tasks</h3>
<p>Here is the complete code to send a list of tasks :</p>
<pre><code class="lang-csharp">    /// &lt;summary&gt;
    ///   The first test developed to validate dependencies subTasking
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;nbTasks&quot;&gt;The number of task to submit&lt;/param&gt;
    /// &lt;param name=&quot;nbInputBytes&quot;&gt;The number of element n x M in the vector&lt;/param&gt;
    /// &lt;param name=&quot;nbOutputBytes&quot;&gt;The number of bytes to expect as result&lt;/param&gt;
    /// &lt;param name=&quot;workloadTimeInMs&quot;&gt;The time spent to compute task&lt;/param&gt;
    private IDisposable ComputeVector(int  nbTasks,
                                      long nbInputBytes,
                                      long nbOutputBytes    = 8,
                                      int  workloadTimeInMs = 1)
    {
      var       indexTask = 0;
      const int elapsed   = 30;

      var inputArrayOfBytes = Enumerable.Range(0,
                                               (int)(nbInputBytes / 8))
                                        .Select(x =&gt; Math.Pow(42.0 * 8 / nbInputBytes,
                                                              1        / 3.0))
                                        .ToArray();

      Logger.LogInformation($&quot;===  Running from {nbTasks} tasks with payload by task {nbInputBytes / 1024.0} Ko Total : {nbTasks * nbInputBytes / 1024.0} Ko...   ===&quot;);
      var sw = Stopwatch.StartNew();
      var periodicInfo = Utils.PeriodicInfo(() =&gt;
                                            {
                                              Logger.LogInformation($&quot;Got {ResultHandle.NbResults} results. All tasks submitted ? {(indexTask == nbTasks).ToString()}&quot;);
                                            },
                                            elapsed);

      var result = Enumerable.Range(0,
                                    nbTasks)
                             .Chunk(nbTasks / Props.MaxParallelChannel)
                             .AsParallel()
                             .Select(subInt =&gt; subInt.Select(idx =&gt; Service.SubmitAsync(&quot;ComputeWorkLoad&quot;,
                                                                                        Utils.ParamsHelper(inputArrayOfBytes,
                                                                                                           nbOutputBytes,
                                                                                                           workloadTimeInMs),
                                                                                        ResultHandle))
                                                     .ToList());

      var taskIds = result.SelectMany(t =&gt; Task.WhenAll(t)
                                               .Result)
                          .ToHashSet();


      indexTask = taskIds.Count();

      Logger.LogInformation($&quot;{taskIds.Count}/{nbTasks} tasks executed in : {sw.ElapsedMilliseconds / 1000.0:0.00} secs with Total bytes {nbTasks * nbInputBytes / 1024.0:0.00} Ko&quot;);

      return periodicInfo;
    }

</code></pre>
<h3 id="result-task-handler">Result task handler</h3>
<pre><code class="lang-csharp">    private class ResultForStressTestsHandler : IServiceInvocationHandler
    {
      private readonly ILogger&lt;StressTests&gt; Logger_;

      public ResultForStressTestsHandler(ILogger&lt;StressTests&gt; Logger)
        =&gt; Logger_ = Logger;

      public int    NbResults { get; private set; }
      public double Total     { get; private set; }

      /// &lt;summary&gt;
      ///   The callBack method which has to be implemented to retrieve error or exception
      /// &lt;/summary&gt;
      /// &lt;param name=&quot;e&quot;&gt;The exception sent to the client from the control plane&lt;/param&gt;
      /// &lt;param name=&quot;taskId&quot;&gt;The task identifier which has invoke the error callBack&lt;/param&gt;
      public void HandleError(ServiceInvocationException e,
                              string                     taskId)

      {
        if (e.StatusCode == ArmonikStatusCode.TaskCanceled)
        {
          Logger_.LogWarning($&quot;Warning from {taskId} : &quot; + e.Message);
        }
        else
        {
          Logger_.LogError($&quot;Error from {taskId} : &quot; + e.Message);
          throw new ApplicationException($&quot;Error from {taskId}&quot;,
                                         e);
        }
      }

      /// &lt;summary&gt;
      ///   The callBack method which has to be implemented to retrieve response from the server
      /// &lt;/summary&gt;
      /// &lt;param name=&quot;response&quot;&gt;The object receive from the server as result the method called by the client&lt;/param&gt;
      /// &lt;param name=&quot;taskId&quot;&gt;The task identifier which has invoke the response callBack&lt;/param&gt;
      public void HandleResponse(object response,
                                 string taskId)

      {
        switch (response)
        {
          case double[] doubles:
            Total += doubles.Sum();
            break;
          case null:
            Logger_.LogInformation(&quot;Task finished but nothing returned in Result&quot;);
            break;
        }

        NbResults++;
      }
    }
</code></pre>
<h3 id="result-output-will-be">Result output will be</h3>
<details><summary>Uncollapse output</summary>
<p>
<pre><code class="lang-log">[10:37:01 INF] ===  Running from 224 tasks with payload by task 3935.3662109375 Ko Total : 881522.03125 Ko...   ===
[10:37:01 INF] Got 0 results. All tasks submitted ? False
[10:37:02 INF] Submitting buffer of 50 task...
[10:37:02 INF] Submitting buffer of 50 task...
[10:37:02 INF] Connecting to armoniK  : https:/xxxxxxxx:5001/ port : 5001
[10:37:02 INF] HTTPS Activated: False
[10:37:02 INF] Created and acquired new channel Grpc.Net.Client.GrpcChannel from pool
[10:37:12 INF] Submitting buffer of 12 task...
[10:37:12 INF] Connecting to armoniK  : https:/xxxxxxxx:5001/ port : 5001
[10:37:12 INF] HTTPS Activated: False
[10:37:12 INF] Created and acquired new channel Grpc.Net.Client.GrpcChannel from pool



[10:43:39 INF] Submitting buffer of 50 task...
[10:43:39 INF] Submitting buffer of 50 task...
[10:43:40 INF] Submitting buffer of 12 task...
[10:43:53 INF] Connecting to armoniK  : https:/xxxxxxxx:5001/ port : 5001
[10:43:53 INF] HTTPS Activated: False
[10:43:53 INF] Created and acquired new channel Grpc.Net.Client.GrpcChannel from pool
[10:44:01 INF] Got 0 results. All tasks submitted ? False
[10:44:31 INF] Got 6 results. All tasks submitted ? False
[10:45:01 INF] Got 6 results. All tasks submitted ? False
[10:45:31 INF] Got 12 results. All tasks submitted ? False

...

[10:50:19 INF] 224/224 tasks executed in : 798.28 secs with Total bytes 881522.03 Ko

...

[11:07:31 INF] Got 174 results. All tasks submitted ? True
[11:07:46 INF] Got 224 results. All tasks submitted ? True
[11:07:46 INF] Total result is 9407.98365779803
</code></pre>
</p>
</details>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/aneoconsulting/ArmoniK.Extensions.Csharp/blob/main/Documentation/articles/buffersubmit.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In This Article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    <!-- Required styles -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
    <!-- Load v9.1.3 of Mermaid -->
    <!-- Hash obtained via https://www.srihash.org/ -->
    <script type="text/javascript" src="https://unpkg.com/mermaid@9.1.3/dist/mermaid.min.js" integrity="sha384-LnGjpNDrP4cp7MIk4CpRa/lPNclrf839ryYVFx1T1mPSV3RGAZ7nlBa7pqcyGY/K" crossorigin="anonymous"></script>
    <!-- Initialize Mermaid -->
    <script>
        mermaid.initialize({
            startOnLoad: false
        });
        mermaid.init(undefined, ".lang-mermaid");
    </script>
  </body>
</html>
